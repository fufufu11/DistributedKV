# C++ 变量类型详解：局部、全局与静态局部变量

## 1. 核心对比

| 变量类型 | 存储位置 | 生命周期 | 作用域 | 初始化 |
| :--- | :--- | :--- | :--- | :--- |
| **局部变量** | **栈 (Stack)** | 函数调用至返回 | 函数/代码块内 | 随机值（除非显式初始化） |
| **全局变量** | **静态存储区** | 程序启动至结束 | 整个文件/工程 | 默认初始化为 0 |
| **静态局部变量** | **静态存储区** | 初次执行至程序结束 | 仅限函数内 | 仅初始化一次，默认为 0 |

---

## 2. 深度解析

### 2.1 局部变量 (Local Variable)
- **特点**：生命周期短，随函数调用创建，随函数返回销毁。
- **示例代码**：
```cpp
#include <iostream>
void test() {
    int a = 10; // 局部变量，在栈上
    std::cout << a << std::endl;
} // a 在这里被销毁
```

### 2.2 全局变量 (Global Variable)
- **特点**：在程序整个运行期间都存在，可被多个函数访问。
- **示例代码**：
```cpp
#include <iostream>
int g_val = 100; // 全局变量
void printGlobal() {
    std::cout << g_val << std::endl;
}
```

### 2.3 静态局部变量 (Static Local Variable)
- **底层机制**：编译器使用标志位确保只初始化一次。
- **持久性**：函数返回后值保留。
- **示例代码**：
```cpp
#include <iostream>
void counter() {
    static int count = 0; // 只在第一次调用时初始化
    count++;
    std::cout << "Count: " << count << std::endl;
}
int main() {
    counter(); // Count: 1
    counter(); // Count: 2
}
```

---

## 3. 内存布局视角
- **栈区 (Stack)**：存放局部变量。
- **静态存储区 (Static Storage Area)**：随程序启动加载，结束销毁。物理上分为：
    - **.data 段**：存放已初始化的全局变量和静态变量（初始值不为 0）。
    - **.bss 段**：存放未初始化或初始化为 0 的全局变量和静态变量。
- **系统自动清零**：指程序加载时，操作系统会将 `.bss` 段内存全部填充为二进制 `0`。因此，全局/静态变量即便不显式初始化，其默认值也确定为 `0`。

---

## 4. 使用场景与最佳实践
- **局部变量**：绝大多数情况下的首选。
- **全局变量**：慎用，仅用于全局共享的常量。
- **静态局部变量**：用于实现单例模式或在函数调用间保持状态。

---

## 5. 常见面试追问
1. **静态局部变量是线程安全的吗？**
   - 答：C++11 后初始化过程线程安全。
2. **全局变量定义在头文件中会怎样？**
   - 答：导致链接错误，应使用 `extern` 或 `inline`。

---
## 6. 综合示例 (可直接运行)

```cpp
#include <iostream>

int g_variable = 100; 

void demoFunction() {
    int local_var = 0;
    static int static_local_var = 0;

    local_var++;
    static_local_var++;

    std::cout << "Local Var: " << local_var 
              << ", Static Local Var: " << static_local_var << std::endl;
}

int main() {
    demoFunction(); // Local: 1, Static: 1
    demoFunction(); // Local: 1, Static: 2
    return 0;
}
```

---

## 7. 面试口语话术

**Q：请简述 C++ 中局部变量、全局变量和静态局部变量的区别。**

**话术建议：**
> “在 C++ 中，这三者主要在**生命周期**、**作用域**和**存储位置**上有明显区别。
> 
> 首先是**局部变量**，它分配在**栈区**，生命周期仅限于所在的函数或代码块，函数返回即销毁。它的初始值是随机的。
> 
> 其次是**全局变量**，它存储在**静态存储区**。程序启动时创建，结束时销毁。它的作用域是整个工程（配合 `extern`），且系统会自动将其初始化为 0（位于 `.bss` 段）。
> 
> 最后是**静态局部变量**，它也存储在**静态存储区**，所以它的生命周期是贯穿整个程序运行期的。但它的作用域被限制在定义它的函数内部。它最核心的特点是**只在第一次执行时初始化一次**，之后调用函数会保留上次的值，常用于实现单例模式或状态计数。”

**Q：追问：全局变量和静态变量在底层存储上有什么细节吗？**

**话术建议：**
> “它们都属于静态存储区，但在底层物理段上有细分。已经初始化且值不为 0 的变量存放在 **`.data` 段**；而未初始化或初始化为 0 的变量存放在 **`.bss` 段**。系统在加载程序时会通过‘自动清零’机制确保 `.bss` 段的变量初始值都为 0。”
